imports:
  Text: Data.Text
  UTCTime: Kernel.Prelude
  BaseUrl: Kernel.Prelude
  MonadFlow: Kernel.Types.App
  HasFlowEnv: Kernel.Types.App
  SearchReqLocation: Domain.Action.UI.Search.Common
  SearchRequest: Domain.Types.SearchRequest
  Meters: Kernel.Types.Common
  Seconds: Kernel.Types.Common
  Language: Tools.Maps
  Merchant: Domain.Types.Merchant
  LatLong: Tools.Maps
  SearchReqMessage: BecknV2.OnDemand.Types
  Intent: BecknV2.OnDemand.Types
  Fulfillment: BecknV2.OnDemand.Types
  Customer: BecknV2.OnDemand.Types
  Person: BecknV2.OnDemand.Types
  mkStops: Beckn.OnDemand.Utils.Search
  mkRouteInfoTags: Beckn.OnDemand.Utils.Search
  mkCustomerInfoTags: Beckn.OnDemand.Utils.Search
  Domain: Kernel.Types.Beckn.Context
  Action: Kernel.Types.Beckn.Context
  City: Kernel.Types.Beckn.Context
  Country: Kernel.Types.Beckn.Context
  Context: BecknV2.OnDemand.Types
  Bool: Kernel.Prelude
  showBaseUrl: Kernel.Prelude
  mkBapUri: Beckn.OnDemand.Utils.Common
  contextSearchAction: Beckn.OnDemand.Utils.Common
  contextMobilityDomain: Beckn.OnDemand.Utils.Common
  buildContextLocation: Beckn.OnDemand.Utils.Common
  getCurrentTime: Kernel.Types.Time
  fromText: Data.UUID
  SearchReq: BecknV2.OnDemand.Types


module: Search
transformer:
  monads:
  - MonadFlow m
  - "HasFlowEnv m r '[\"nwAddress\" ::: BaseUrl]"
  transformers:
    buildBecknSearchReqV2:
      params:
        - origin: SearchReqLocation
        - destination: SearchReqLocation
        - searchId : Id SearchRequest
        - distance: Maybe Meters
        - duration: Maybe Seconds
        - customerLanguage: Maybe Language
        - disabilityTag: Maybe Text
        - merchant: Merchant
        - mbPoints: Maybe [LatLong]
        - mbPhoneNumber: Maybe Text
      toType: SearchReq
      mapping:
        searchReqContext: /~buildContextV2 searchId.getId (Just searchId.getId) merchant.bapId merchant.id Nothing Nothing merchant.defaultCity merchant.country
        searchReqMessage: /~buildSearchMessageV2 origin destination distance duration customerLanguage disabilityTag mbPoints mbPhoneNumber

    buildContextV2:
      params:
        - messageId: Text
        - transactionId: Maybe Text
        - bapId: Text
        - merchantId: Id Merchant
        - bppId: Maybe Text
        - bppUri: Maybe BaseUrl
        - city: City
        - country: Country
        # - autoAssignEnabled: Bool
      toType: Context
      mapping:
        contextAction: ~_contextSearchAction
        contextBapId: Just bapId
        contextBapUri: /~_mkBapUri merchantId
        contextBppId: bppId
        contextBppUri: ~_showBaseUrl <$> bppUri
        contextDomain: ~_contextMobilityDomain
        contextKey: Nothing
        contextLocation: ~_buildContextLocation city country
        contextMessageId: ~_fromText messageId
        contextTimestamp: /~_getCurrentTime <&> Just
        contextTransactionId: ~_fromText =<< transactionId
        contextTtl: Nothing
        contextVersion: Just "2.0.0"

    buildSearchMessageV2:
      params:
        - origin: SearchReqLocation
        - destination: SearchReqLocation
        - distance: Maybe Meters
        - duration: Maybe Seconds
        - customerLanguage: Maybe Language
        - disabilityTag: Maybe Text
        - mbPoints: Maybe [LatLong]
        - mbPhoneNumber: Maybe Text
      toType: SearchReqMessage
      mapping:
        searchReqMessageIntent: /~Just <$> tfIntent origin destination customerLanguage disabilityTag distance duration mbPoints mbPhoneNumber

    tfIntent:
      params:
        - origin: SearchReqLocation
        - destination: SearchReqLocation
        - customerLanguage: Maybe Language
        - disabilityTag: Maybe Text
        - distance: Maybe Meters
        - duration: Maybe Seconds
        - mbPoints: Maybe [LatLong]
        - mbPhoneNumber: Maybe Text
      toType: Intent
      mapping:
        intentFulfillment: /~Just <$> tfFulfillment origin destination customerLanguage disabilityTag distance duration mbPoints mbPhoneNumber
        intentPayment: Nothing
        intentTags: Nothing

    tfFulfillment:
      params:
        - origin: SearchReqLocation
        - destination: SearchReqLocation
        - customerLanguage: Maybe Language
        - disabilityTag: Maybe Text
        - distance: Maybe Meters
        - duration: Maybe Seconds
        - mbPoints: Maybe [LatLong]
        - mbPhoneNumber: Maybe Text
      toType: Fulfillment
      mapping:
        fulfillmentStops: ~_mkStops origin destination
        fulfillmentCustomer: /~Just <$> tfCustomer customerLanguage disabilityTag mbPhoneNumber
        fulfillmentTags: ~_mkRouteInfoTags distance duration mbPoints
        fulfillmentAgent: Nothing
        fulfillmentId: Nothing
        fulfillmentState: Nothing
        fulfillmentType: Nothing
        fulfillmentVehicle: Nothing

    tfCustomer:
      params:
        - customerLanguage: Maybe Language
        - disabilityTag: Maybe Text
        - mbPhoneNumber: Maybe Text
      toType: Customer
      mapping:
        customerPerson: /~Just <$> tfPerson customerLanguage disabilityTag mbPhoneNumber
        customerContact: Nothing

    tfPerson:
      params:
        - customerLanguage: Maybe Language
        - disabilityTag: Maybe Text
        - mbPhoneNumber: Maybe Text
      toType: Person
      mapping:
        personTags: ~_mkCustomerInfoTags customerLanguage disabilityTag mbPhoneNumber
        personName: Nothing
        personId: Nothing

types:
  SearchReq:
    context: Context
    message: SearchMessage

  Context:
    action: ContextAction
    messageId: Text
    transactionId: Text
    bapId: Text
    bapUri: BaseUrl
    loction: ContextLocation
    bapCity: Text
    bapCountry: Text

  ContextAction:
    enum: "search,on_search"

  ContextLocation:
    city: Descriptor
    country: Descriptor

  Descriptor:
    code: Text

  SearchMessage:
    intent: SearchIntent

  SearchIntent:
    fulfillment: SearchFulfillment

  SearchFulfillment:
    stops: [FulfillmentStop]

  FulfillmentStop:
    location: Location

  Location:
    gps: Text

  DSearchReq:
    messageId: Text
    transactionId: Text
    bapId: Text
    bapUri: BaseUrl
    bapCity: Text
    bapCountry: Text
    customerPhoneNum: Maybe Text
    pickupLocation: LatLong
    pickupTime: UTCTime
    dropLocation: LatLong
    pickupAddress: Maybe Address
    dropAddrress: Maybe Address
    routeDistance: Maybe Meters
    routeDuration: Maybe Seconds
    device: Maybe Text
    disabilityTag: Maybe Text
    routePoints: Maybe [LatLong]

  Address:
    city: Text
    area: Text

  LatLong:
    lat: Double
    lon: Double

  Meters:
    getMeters: Int

  Seconds:
    getSeconds: Int

# transformer:
#   monads:
#     - MonadThrow m
#     - MonadTime m
#     - Log m
#   transformers:
#     buildBecknSearchReq:
#       # extraMonads: should we allow this
#       params:
#         domainSearchReq: Maybe (Id DomainSearchReq)
#         context: Context
#       toType: BecknSearchReq
#       mapping:
#         searchReqContext: ~_context context
#         searchReqMessage: Just 10

  # ~  -> pure    Haskell functions
  # /~ -> impure  Haskell functions
